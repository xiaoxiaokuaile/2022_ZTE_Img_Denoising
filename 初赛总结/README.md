# 2022 中兴捧月图像去噪 初赛Rank12方案

### 1. 赛事背景

 图像去噪是机器视觉领域重要任务，图像去噪模块在安防，自动驾驶，传感，医学影像，消费电子等领域都是重要的前端图像处理模块。消费级电子产品(例如手机)出于成本考虑，在低照度和高ISO条件下，噪声对成像质量的降级更加严重。对于传统图像处理算法，常见去噪算法包含双边(bilateral)滤波，NLM (non local mean)滤波，BM3D，多帧(3D)降噪方案等多种方案，产品实现上需要兼顾性能和复杂度。
AI可进一步提升图像主客观质量在学术和工业界得到了广泛认证。对于手机产品，AI正快速补充和替代传统手机ISP(Image signal processing)中的痛点难点，例如可进行AI-based去噪，动态范围增强，超分辨，超级夜景，甚至AI ISP等。 

### 2.  评分规则

 Score = (w * max(psnr - psnr_min, 0) / (psnr_max - psnr_min) + (1 - w) * max(ssim - ssim_min, 0) / (1 - ssim_min)) * 100， 

其中w为PSNR (dB)和SSIM权重，psnr和ssim为参赛者得到的psnr (dB)和ssim，psnr_min为psnr得分下限值，ssim_min为ssim得分下限值。例如一组参考值为：[w, psnr_max, psnr_min, ssim_min] = [0.8, 60, 30, 0.8]
根据文档质量和算法原创性，额外有[0-5]分浮动，即初赛满分105分。 

### 3. 数据分析

训练集数据一共100张3472×4024分辨率的图，由于租用的机器为单卡V100-16G，整图参与训练不方便，故将每张图裁剪为320张256×256大小的切片图，以4个角为基准每个角裁剪8×10=80张图并保存为.bin格式，最终数据集为32000张256×256的切片图，切割方式如图4所示：

![](https://github.com/xiaoxiaokuaile/2022_ZTE_Img_Denoising/blob/master/%E5%88%9D%E8%B5%9B%E6%80%BB%E7%BB%93/README_img/%E5%88%9D%E8%B5%9B%E5%88%87%E5%9B%BE.png)

#####                                                                          图1：数据集切分效果图  

原始数据集：链接：https://pan.baidu.com/s/10sFJx0uy2_bfe39JXqo-Lw  提取码：nek6

切图数据集：链接：https://pan.baidu.com/s/1GdJboslFWczkM0apLMAJ1A  提取码：bd24

### 4. 数据增强

数据增强的尝试除了常用的一些图片翻转、旋转、Cut、Mix等，又分析了训练集以及测试集的噪声特点，对噪声作了放缩数据增强操作。

先是使用gt图减去noise图得到噪声矩阵，载对每张图的噪声分布作统计,统计的参数有噪声均值、噪声绝对值的均值、每张图噪声最小值、最大值、方差、0.01分位数、0.99分位数，其中测试集的统计则是利用当时效果比较好的模型预测结果作为gt图统计，训练集及测试集的噪声信息统计结果如下表所示：

##### 表1.训练集噪声特征统计

| **索引** | **均值** | **绝对值均值** | **最小值** | **最大值** | **方差** | **0.01分位数** | **0.99分位数** |
| -------- | -------- | -------------- | ---------- | ---------- | -------- | -------------- | -------------- |
| 0        | -2.23    | 141.59         | -4072      | 3235       | 212.66   | -661           | 528            |
| 1        | 4.29     | 140.21         | -4023      | 3080       | 210.54   | -617           | 578            |
| …        | …        | …              | …          | …          | …        | …              | …              |
| 39       | -0.4     | 109.73         | -887       | 977        | 141.20   | -340           | 356            |
| 40       | 4.37     | 102.88         | -3179      | 3451       | 144.25   | -352           | 397            |
| …        | …        | …              | …          | …          | …        | …              | …              |
| 98       | 27.33    | 196.56         | -5792      | 4269       | 269.37   | -645           | 708            |
| 99       | 23.65    | 204.40         | -5709      | 4240       | 307.92   | -952           | 795            |

##### 表2.测试集集噪声特征统计

| **索引** | **均值** | **绝对值均值** | **最小值** | **最大值** | **方差** | **0.01分位数** | **0.99分位数** |
| -------- | -------- | -------------- | ---------- | ---------- | -------- | -------------- | -------------- |
| 0        | 28.66    | 192.34         | -4456      | 4489       | 253.82   | -589           | 690            |
| 1        | 12.33    | 212.56         | -5911      | 5614       | 301.68   | -690           | 901            |
| 2        | 14.79    | 204.63         | -7347      | 5122       | 290.75   | -642           | 876            |
| 3        | 19.92    | 166.62         | -7451      | 5337       | 251.80   | -539           | 769            |
| 4        | -3.61    | 229.68         | -5892      | 4511       | 331.41   | -912           | 922            |
| 5        | -2.36    | 176.82         | -3691      | 2997       | 236.86   | -614           | 590            |
| 6        | -11.5    | 295.58         | -7510      | 6715       | 491.68   | -1768          | 1378           |
| 7        | 15.32    | 190.47         | -6975      | 5235       | 296.44   | -717           | 869            |
| 8        | -1.46    | 261.57         | -6935      | 5805       | 388.34   | -1050          | 1046           |
| 9        | 99.05    | 595.69         | -15041     | 10675      | 973.87   | -3178          | 2808           |

绘制噪点分布直方图：

![](https://github.com/xiaoxiaokuaile/2022_ZTE_Img_Denoising/blob/master/%E5%88%9D%E8%B5%9B%E6%80%BB%E7%BB%93/README_img/%E8%AE%AD%E7%BB%83%E9%9B%86%E5%99%AA%E7%82%B9%E5%88%86%E5%B8%83%E7%9B%B4%E6%96%B9%E5%9B%BE.png)

#####                                                                          图2：训练集噪点分布直方图

![](https://github.com/xiaoxiaokuaile/2022_ZTE_Img_Denoising/blob/master/%E5%88%9D%E8%B5%9B%E6%80%BB%E7%BB%93/README_img/%E6%B5%8B%E8%AF%95%E9%9B%86%E5%99%AA%E7%82%B9%E5%88%86%E5%B8%83.png)

#####                                                                          图3：测试集噪点分布直方图

在竞赛初期赛题组出题专家有说有五类噪声,根据上面表图分析可知这五种类型数据应当是五种不同参数的高斯噪声分布，为了更直观进行分类，将噪声可视化为三维图如图7所示：

![](https://github.com/xiaoxiaokuaile/2022_ZTE_Img_Denoising/blob/master/%E5%88%9D%E8%B5%9B%E6%80%BB%E7%BB%93/README_img/%E8%AE%AD%E7%BB%83%E9%9B%86%E5%99%AA%E5%A3%B0%E5%88%86%E5%B8%831.png)

#####                                                      (a)噪声分布1,第1-20张图,大致范围[-2500,2500]

![](https://github.com/xiaoxiaokuaile/2022_ZTE_Img_Denoising/blob/master/%E5%88%9D%E8%B5%9B%E6%80%BB%E7%BB%93/README_img/%E8%AE%AD%E7%BB%83%E9%9B%86%E5%99%AA%E5%A3%B0%E5%88%86%E5%B8%832.png)

#####                                                     (b)噪声分布2, 第21-40张图,大致范围[-1000,1000]

![](https://github.com/xiaoxiaokuaile/2022_ZTE_Img_Denoising/blob/master/%E5%88%9D%E8%B5%9B%E6%80%BB%E7%BB%93/README_img/%E8%AE%AD%E7%BB%83%E9%9B%86%E5%99%AA%E5%A3%B0%E5%88%86%E5%B8%833.png)

#####                                                    (c)噪声分布3,第41-60张图,大致范围[-2000,2000]

![](https://github.com/xiaoxiaokuaile/2022_ZTE_Img_Denoising/blob/master/%E5%88%9D%E8%B5%9B%E6%80%BB%E7%BB%93/README_img/%E8%AE%AD%E7%BB%83%E9%9B%86%E5%99%AA%E5%A3%B0%E5%88%86%E5%B8%834.png)

#####                                                     (d)噪声分布4,第61-80张图,大致范围[-5000,5000]

![](https://github.com/xiaoxiaokuaile/2022_ZTE_Img_Denoising/blob/master/%E5%88%9D%E8%B5%9B%E6%80%BB%E7%BB%93/README_img/%E8%AE%AD%E7%BB%83%E9%9B%86%E5%99%AA%E5%A3%B0%E5%88%86%E5%B8%835.png)

#####                                                     (e)噪声分布5,第81-100张图,大致范围[-5000,0]

#####                                                                          图4：训练集五种噪声分布  

![](https://github.com/xiaoxiaokuaile/2022_ZTE_Img_Denoising/blob/master/%E5%88%9D%E8%B5%9B%E6%80%BB%E7%BB%93/README_img/%E6%B5%8B%E8%AF%95%E9%9B%86%E5%99%AA%E5%A3%B0.png)

#####                                                                              图4.测试集噪声分布

从测试集的噪声分布来看,noise0,noise5属于噪声1;noise1,noise2,noise3,noise6, noise7,noise8属于噪声4; noise4属于噪声5;而**noise9**的噪声范围达到了[-10000,10000]在训练集中是不存在的,推测可能噪声高斯分布的方差不一致导致的,针对该样本采用了随机放缩噪声幅度的数据增强方法,训练集中噪声最大放大2倍,以此来增强对noise9样本的去噪能力。

### 5. 模型实验

有关模型的尝试主要有

**CNN:** Unet,Unet++,Unet+++,改进UNet++;

**Transformer: **Restormer;

**CNN+注意力: **MPRNet

#### 5.1.Unet网络实验：

![](https://github.com/xiaoxiaokuaile/2022_ZTE_Img_Denoising/blob/master/%E5%88%9D%E8%B5%9B%E6%80%BB%E7%BB%93/README_img/Unet%E7%BB%93%E6%9E%84.png)

#####                                                                          图5.Unet网络结构

##### 表3.Unet网络实验结果

| **网络**    | **模型大小** | **epoch** | **Lr**   | **学习策略** | **Los**     | **分数**  |
| ----------- | ------------ | --------- | -------- | ------------ | ----------- | --------- |
| baseline    | 29.6M        | 100       | 3e-4     | cos          | 0.00475     | 50.19     |
| Unet        | 118.4M       | 100       | 3e-4     | cos          | 0.00296     | 53.50     |
| B0-Unet     | 16.2M        | 100       | 3e-4     | cos          | 0.00505     | 50.11     |
| B1-Unet     | 25.8M        | 100       | 3e-4     | cos          | 0.00446     | 50.90     |
| B2-Unet     | 30.4M        | 100       | 3e-4     | cos          | 0.00432     | 51.86     |
| **B3-Unet** | **42.3M**    | **100**   | **3e-4** | **cos**      | **0.00368** | **53.16** |

其中Loss为L2 Loss乘以100倍得到的，后面表格同理  

### 5.2. Unet++结构网络实验：  

![](https://github.com/xiaoxiaokuaile/2022_ZTE_Img_Denoising/blob/master/%E5%88%9D%E8%B5%9B%E6%80%BB%E7%BB%93/README_img/Unet%2B%2B%E7%BB%93%E6%9E%84.png)

#####                                                                                    图6.Unet++网络结构

##### 表4.Unet++网络实验结果

| **网络**      | **模型大小** | **epoch** | **Lr**   | **学习策略** | **Los**     | **分数**  |
| ------------- | ------------ | --------- | -------- | ------------ | ----------- | --------- |
| Unet++512     | 34.5M        | 100       | 3e-4     | cos          | 0.00330     | 53.17     |
| Unet++1024    | 138.0M       | 100       | 1.5e-4   | cos          | 0.00296     | 54.47     |
| B0-Unet++     | 16.8M        | 100       | 3e-4     | cos          | 0.00355     | 53.06     |
| B1-Unet++     | 26.5M        | 100       | 3e-4     | cos          | 0.00347     | 53.75     |
| B2-Unet++     | 31.2M        | 100       | 3e-4     | cos          | 0.00344     | 53.61     |
| B3-Unet++     | 43.4M        | 100       | 3e-4     | cos          | 0.00309     | 55.22     |
| B4-Unet++     | 70.2M        | 100       | 3e-4     | cos          | 0.00316     | 54.97     |
| **B5-Unet++** | **112.1M**   | **100**   | **1e-4** | **cos**      | **0.00341** | **54.39** |

结合Unet以及Unet++的训练结果来看,Unet++的效果是明显优于Unet的，此外在对单张图进行分析时候,发现前9张测试图较浅的CNN网络预测结果较好, 而对于第10张图，较深的网路预测结果比较好,这说明前9张图比较依赖局部特征，而第九张图比较依赖全局特征，这就有点矛盾的现象了，为此如何设计一个网络能较好的结合深度特征以及浅层特征是一个关键上分点。

### 5.3.改进 Unet++结构网络实验：

![](https://github.com/xiaoxiaokuaile/2022_ZTE_Img_Denoising/blob/master/%E5%88%9D%E8%B5%9B%E6%80%BB%E7%BB%93/README_img/%E6%94%B9%E8%BF%9BUnet%E7%BB%93%E6%9E%84.png)

#####                                                                           图7.改进Unet++网络结构

结合Unet++以及Unet的网络结构设计了如上图所示的3Unet结构,中间是Unet++的架构，左右两边各是一个3层的Unet结构,Unet++的浅层网络输出(前三层)作为左Unet的输入，Unet++的深层网络输出(后三层)作为右Unet的输入,网络之间的特征有concat拼接操作,损失计算为网络各个出口输出的加权和。

以EfficientNetB3模型作为该网络的backbone,最终网络得分54.67，逐张图分析发现该网络尽管能融合浅层及深层特征，但是它在提升第10张图预测效果同时前9张图的预测效果也相应的有小幅下降，是对网络效果作了一些折中处理，所以该方案尽管有一定的缓解，但是还无法真正结合局部以及全局特征。

### 5.4. Restormer网络结构实验：  

![](https://github.com/xiaoxiaokuaile/2022_ZTE_Img_Denoising/blob/master/%E5%88%9D%E8%B5%9B%E6%80%BB%E7%BB%93/README_img/Restomer%E7%BB%93%E6%9E%84.png)

#####                                                                               图8.Restormer网络结构

结合前面分析得知第10张图是需要全局信息才能较好预测的，而transformer结构能较好地处理全局信息,因而采用Restormer网络结构进行实验,实验结果如下表：

| **网络**      | **模型大小** | **epoch** | **Lr**   | **学习策略** | **Los**     | **分数**  |
| ------------- | ------------ | --------- | -------- | ------------ | ----------- | --------- |
| **Restormer** | **45.6M**    | **100**   | **1e-4** | **cos**      | **0.00230** | **55.97** |

逐张图分析发现第10张图的预测效果确实有了明显的提升，说明Restormer确实捕捉到了全局信息，但是前9张图预测效果却没有明显提升，甚至有微幅下降，这也表明Restormer对于局部信息的捕捉在本题中是不如CNN结构的，为此如何设计出一个有着CNN的局部特征提取能力又有Transformer的全局特征提取能力的网络是必须的。

查阅大量论文发现MPRNet刚好具备这样的特性，下面就对齐作介绍。

### 5.5.MPRNet网络结构实验    

![](https://github.com/xiaoxiaokuaile/2022_ZTE_Img_Denoising/blob/master/%E5%88%9D%E8%B5%9B%E6%80%BB%E7%BB%93/README_img/MPRNet%E7%BB%93%E6%9E%84.png)

#####                                                                         图9.MPRNet网络结构

调整MPRNet的通道数为64使其满足50M模型参数的要求，训练步骤如下：

(1) 原始数据直接训练训练100代,L2 loss，最终得分为57.39;

(2) 使用**数据增强**继续微调训练50epoch,L2 Loss,最终得分可以达到57.63；

(3) 使用**数据增强**继续微调训练50epoch,**L1 Loss**,最终得分可以达到**58.84**；

10张图的预测效果相较于其它模型均有不同程度的提升，效果非常好。

表5. MPRNet 网络实验结果

| **网络**   | **模型大小** | **epoch** | **Lr**   | **说明**       | **Los**     | **分数**  |
| ---------- | ------------ | --------- | -------- | -------------- | ----------- | --------- |
| MPRNet     | 45.6M        | 100       | 1e-4     | 原始训练       | 0.00193     | 57.39     |
| MPRNet     | 45.6M        | 50        | 7e-5     | L2增强微调     | 0.00160     | 58.38     |
| **MPRNet** | **45.6M**    | **50**    | **7e-5** | **L1增强微调** | **0.23197** | **58.84** |

### 6.模型推理

将原图切分为4×5=20张图片并overlap预测，预测效果不会受到影响。

模型权重：链接：https://pan.baidu.com/s/1yFGCnN-W_7f-P1h6hf9CWw  提取码：0l6b

### 7.其它操作

此外还尝试了将SIDD数据集加入训练集一并训练，发现对预测效果没有太大帮助，而且训练比较费时，就舍弃该操作。

### 8.参考文献

链接：https://pan.baidu.com/s/109WCMJI9K4wa7UaaXf4Thg   提取码：gse9

































